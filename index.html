<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CryptoMiner Clicker</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');
:root{--bg:#04040a;--s1:#08080f;--s2:#0e0e1a;--border:#1a1a30;
  --gold:#ffd700;--green:#00ff88;--blue:#00cfff;--purple:#a855f7;
  --red:#ff4466;--text:#c8c8e8;--muted:#555570;
  --common:#a0a0c0;--rare:#4488ff;--epic:#cc44ff;--legendary:#ff9900;}
*{margin:0;padding:0;box-sizing:border-box;user-select:none;}
body{background:var(--bg);color:var(--text);font-family:'Share Tech Mono',monospace;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;
  background:linear-gradient(rgba(0,207,255,.03) 1px,transparent 1px) 0 0/40px 40px,
             linear-gradient(90deg,rgba(0,207,255,.03) 1px,transparent 1px) 0 0/40px 40px;
  pointer-events:none;z-index:0;}
body::after{content:'';position:fixed;inset:0;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.12) 2px,rgba(0,0,0,.12) 4px);
  pointer-events:none;opacity:.35;z-index:0;}
header{text-align:center;padding:12px;border-bottom:1px solid var(--border);
  background:linear-gradient(180deg,rgba(0,207,255,.06),transparent);position:relative;z-index:1;}
header h1{font-family:'Orbitron',sans-serif;font-size:1.4rem;font-weight:900;letter-spacing:.15em;
  background:linear-gradient(90deg,var(--gold),var(--green),var(--blue));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
header p{font-size:.6rem;color:var(--muted);letter-spacing:.18em;text-transform:uppercase;margin-top:3px;}
.nav-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--s1);position:relative;z-index:1;}
.nav-tab{flex:1;padding:9px 4px;font-family:'Orbitron',sans-serif;font-size:.58rem;letter-spacing:.06em;
  text-transform:uppercase;background:transparent;border:none;border-bottom:2px solid transparent;
  color:var(--muted);cursor:pointer;transition:all .2s;}
.nav-tab.active{color:var(--blue);border-bottom-color:var(--blue);}
.nav-tab .tab-badge{display:inline-block;background:var(--red);color:#fff;font-size:.45rem;
  padding:1px 4px;border-radius:8px;margin-left:3px;vertical-align:middle;animation:pulse .8s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.page{display:none;position:relative;z-index:1;}
.page.active{display:block;}
.game{display:grid;grid-template-columns:1fr 260px;min-height:calc(100vh - 108px);}
.center{display:flex;flex-direction:column;align-items:center;padding:20px 14px;border-right:1px solid var(--border);}
.balance-amount{font-family:'Orbitron',sans-serif;font-size:1.9rem;font-weight:900;
  color:var(--gold);text-shadow:0 0 20px rgba(255,215,0,.4);}
.balance-label{font-size:.58rem;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;margin-top:2px;}
.per-sec{font-size:.7rem;color:var(--green);letter-spacing:.07em;margin-top:3px;}
.coin-wrap{position:relative;margin:18px 0;}
.coin-btn{width:150px;height:150px;border-radius:50%;
  background:radial-gradient(circle at 35% 35%,#ffe566,#b8860b 60%,#7a5c00);
  border:4px solid var(--gold);
  box-shadow:0 0 28px rgba(255,215,0,.3),0 0 56px rgba(255,215,0,.1),inset 0 2px 8px rgba(255,255,255,.3);
  cursor:pointer;transition:transform .08s,box-shadow .08s;
  display:flex;align-items:center;justify-content:center;font-size:3.2rem;position:relative;overflow:hidden;}
.coin-btn:hover{box-shadow:0 0 40px rgba(255,215,0,.5),0 0 80px rgba(255,215,0,.15),inset 0 2px 8px rgba(255,255,255,.3);}
.coin-btn:active{transform:scale(.89)!important;}
.float-text{position:fixed;font-family:'Orbitron',sans-serif;font-weight:700;
  font-size:1rem;color:var(--gold);pointer-events:none;z-index:999;
  text-shadow:0 0 8px rgba(255,215,0,.6);animation:floatUp .8s ease forwards;}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-70px) scale(.6)}}
.click-info{display:flex;gap:18px;margin-top:5px;font-size:.66rem;color:var(--muted);}
.click-info strong{color:var(--green);}
.level-wrap{width:100%;max-width:290px;margin-top:14px;}
.level-label{display:flex;justify-content:space-between;font-size:.6rem;color:var(--muted);margin-bottom:5px;}
.level-bar{height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.level-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--blue));border-radius:3px;transition:width .3s;}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;width:100%;max-width:290px;margin-top:14px;}
.stat-box{background:var(--s2);border:1px solid var(--border);padding:8px 11px;border-radius:2px;}
.stat-box .val{font-family:'Orbitron',sans-serif;font-size:.82rem;color:var(--blue);}
.stat-box .lbl{font-size:.56rem;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-top:2px;}
.eq-strip-wrap{width:100%;max-width:290px;margin-top:12px;}
.eq-strip-title{font-size:.58rem;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;margin-bottom:6px;}
.eq-strip{display:flex;gap:5px;}
.eq-slot{width:42px;height:42px;border-radius:2px;border:1px solid var(--border);background:var(--s2);
  display:flex;align-items:center;justify-content:center;font-size:1.2rem;position:relative;cursor:pointer;transition:border-color .2s;}
.eq-slot.has-item{border-color:var(--blue);}
.eq-slot .srb{position:absolute;bottom:0;left:0;right:0;height:2px;border-radius:0 0 2px 2px;}
.prestige-btn{margin-top:12px;padding:7px 16px;
  background:rgba(168,85,247,.1);border:1px solid var(--purple);color:var(--purple);
  font-family:'Orbitron',sans-serif;font-size:.6rem;letter-spacing:.1em;cursor:pointer;
  border-radius:2px;transition:all .2s;text-transform:uppercase;}
.prestige-btn:hover:not(:disabled){background:rgba(168,85,247,.25);}
.prestige-btn:disabled{opacity:.3;cursor:not-allowed;}
.achievements{padding:8px 12px;border-top:1px solid var(--border);background:var(--s1);
  display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
.ach-title{font-size:.56rem;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;width:100%;margin-bottom:3px;}
.ach{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:.85rem;border:2px solid var(--border);background:var(--s2);filter:grayscale(1);opacity:.3;transition:all .3s;}
.ach.unlocked{filter:none;opacity:1;border-color:var(--gold);box-shadow:0 0 8px rgba(255,215,0,.3);}
.shop{background:var(--s1);overflow-y:auto;padding:13px;}
.shop-title{font-family:'Orbitron',sans-serif;font-size:.72rem;font-weight:700;color:var(--blue);
  letter-spacing:.14em;text-transform:uppercase;margin-bottom:11px;padding-bottom:6px;border-bottom:1px solid var(--border);}
.upgrade-card{background:var(--s2);border:1px solid var(--border);border-radius:2px;
  padding:9px;margin-bottom:6px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
.upgrade-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;}
.upgrade-card:hover:not(.locked){border-color:var(--gold);transform:translateX(2px);}
.upgrade-card.locked{opacity:.4;cursor:not-allowed;}
.upgrade-card.affordable::before{background:var(--gold);}
.upgrade-card.locked::before{background:var(--muted);}
.ug-head{display:flex;align-items:center;gap:7px;margin-bottom:4px;}
.ug-icon{font-size:1.1rem;width:26px;text-align:center;}
.ug-name{font-family:'Orbitron',sans-serif;font-size:.65rem;font-weight:700;color:var(--text);}
.ug-owned{margin-left:auto;font-size:.58rem;background:rgba(0,207,255,.1);
  color:var(--blue);border:1px solid rgba(0,207,255,.25);padding:1px 5px;border-radius:2px;}
.ug-desc{font-size:.58rem;color:var(--muted);margin-bottom:4px;line-height:1.4;}
.ug-foot{display:flex;align-items:center;justify-content:space-between;}
.ug-cost{font-size:.65rem;color:var(--gold);}
.ug-cost.cant{color:var(--red);}
.ug-effect{font-size:.58rem;color:var(--green);}

/* ITEMS PAGE */
.items-page{padding:18px 20px;}
.items-page h2{font-family:'Orbitron',sans-serif;font-size:.85rem;font-weight:700;color:var(--blue);letter-spacing:.14em;text-transform:uppercase;}
.items-page .subtitle{font-size:.62rem;color:var(--muted);margin:4px 0 18px;}
.section-title{font-family:'Orbitron',sans-serif;font-size:.66rem;color:var(--text);letter-spacing:.12em;
  text-transform:uppercase;margin-bottom:9px;padding-bottom:5px;border-bottom:1px solid var(--border);}
.equip-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;max-width:380px;margin-bottom:22px;}
.equip-slot{aspect-ratio:1;border-radius:3px;border:1px dashed var(--border);background:var(--s2);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
.equip-slot:hover{border-color:var(--muted);}
.equip-slot.filled{border-style:solid;}
.equip-slot .es-type{position:absolute;top:3px;left:0;right:0;text-align:center;font-size:.45rem;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;}
.equip-slot .es-icon{font-size:1.5rem;}
.equip-slot .es-name{font-size:.48rem;color:var(--muted);text-align:center;margin-top:2px;line-height:1.2;padding:0 2px;}
.equip-slot .es-bar{position:absolute;bottom:0;left:0;right:0;height:3px;}
.inventory-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(78px,1fr));gap:7px;}
.inv-item{background:var(--s2);border-radius:3px;border:1px solid var(--border);
  padding:8px 5px;display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:all .2s;position:relative;}
.inv-item:hover{transform:translateY(-2px);}
.inv-item .eqbadge{position:absolute;top:3px;right:3px;font-size:.44rem;background:rgba(0,207,255,.2);
  color:var(--blue);padding:1px 3px;border-radius:2px;}
.inv-item .listbadge{position:absolute;top:3px;left:3px;font-size:.44rem;background:rgba(255,215,0,.15);
  color:var(--gold);padding:1px 3px;border-radius:2px;}
.inv-icon{font-size:1.7rem;margin-bottom:3px;}
.inv-name{font-size:.53rem;text-align:center;color:var(--text);line-height:1.3;}
.inv-rarity{font-size:.48rem;text-transform:uppercase;letter-spacing:.08em;margin-top:2px;}
.inv-stats{font-size:.48rem;color:var(--green);margin-top:3px;text-align:center;line-height:1.4;}
.empty-inv{font-size:.7rem;color:var(--muted);text-align:center;padding:28px;
  border:1px dashed var(--border);border-radius:3px;line-height:2.2;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:100;
  display:flex;align-items:center;justify-content:center;}
.modal{background:var(--s2);border:1px solid var(--border);border-radius:3px;
  padding:22px;min-width:270px;max-width:340px;position:relative;}
.modal-icon{font-size:2.8rem;text-align:center;margin-bottom:7px;}
.modal-name{font-family:'Orbitron',sans-serif;font-size:.95rem;font-weight:700;text-align:center;margin-bottom:3px;}
.modal-rarity{font-size:.62rem;text-transform:uppercase;letter-spacing:.14em;text-align:center;margin-bottom:11px;}
.modal-desc{font-size:.67rem;color:var(--muted);text-align:center;margin-bottom:12px;line-height:1.6;}
.modal-stats{background:var(--bg);border-radius:2px;padding:9px;margin-bottom:12px;}
.modal-stat{display:flex;justify-content:space-between;font-size:.65rem;margin-bottom:3px;}
.modal-stat:last-child{margin-bottom:0;}
.modal-stat .sv{color:var(--green);}
.modal-btns{display:flex;gap:7px;flex-wrap:wrap;}
.modal-btn{flex:1;min-width:60px;padding:7px;font-family:'Orbitron',sans-serif;font-size:.58rem;letter-spacing:.07em;
  text-transform:uppercase;cursor:pointer;border-radius:2px;transition:all .2s;border:1px solid;}
.btn-equip{background:rgba(0,207,255,.08);border-color:var(--blue);color:var(--blue);}
.btn-equip:hover{background:rgba(0,207,255,.22);}
.btn-unequip{background:rgba(255,68,102,.08);border-color:var(--red);color:var(--red);}
.btn-unequip:hover{background:rgba(255,68,102,.22);}
.btn-close{background:var(--s1);border-color:var(--border);color:var(--muted);}
.btn-close:hover{color:var(--text);}
.btn-sell{background:rgba(255,215,0,.08);border-color:var(--gold);color:var(--gold);}
.btn-sell:hover{background:rgba(255,215,0,.22);}
.modal-sell-area{margin-top:8px;padding:8px;background:var(--bg);border-radius:2px;border:1px solid var(--border);}
.modal-sell-area label{font-size:.58rem;color:var(--muted);display:block;margin-bottom:5px;}
.modal-sell-row{display:flex;gap:6px;align-items:center;}
.modal-sell-input{flex:1;background:var(--s1);border:1px solid var(--border);color:var(--text);
  font-family:'Share Tech Mono',monospace;font-size:.7rem;padding:5px 8px;border-radius:2px;outline:none;}
.modal-sell-input:focus{border-color:var(--gold);}
.sell-currency-toggle{display:flex;gap:4px;margin-bottom:6px;}
.sct-btn{padding:3px 8px;font-size:.55rem;font-family:'Orbitron',sans-serif;cursor:pointer;
  border-radius:2px;border:1px solid var(--border);background:var(--s1);color:var(--muted);transition:all .2s;}
.sct-btn.active{border-color:var(--gold);color:var(--gold);background:rgba(255,215,0,.1);}

/* DROP SCREEN */
.drop-overlay{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:200;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;}
.drop-title{font-family:'Orbitron',sans-serif;font-size:1.1rem;font-weight:900;
  letter-spacing:.2em;color:var(--purple);text-shadow:0 0 20px rgba(168,85,247,.5);}
.drop-subtitle{font-size:.65rem;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;}
.drop-token-reward{font-size:.72rem;color:var(--gold);background:rgba(255,215,0,.08);
  border:1px solid rgba(255,215,0,.25);padding:6px 18px;border-radius:3px;letter-spacing:.1em;}
.drop-items{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;max-width:480px;}
.drop-item{background:var(--s2);border-radius:4px;padding:14px 10px;
  display:flex;flex-direction:column;align-items:center;gap:5px;min-width:88px;
  animation:dropIn .4s ease forwards;opacity:0;}
@keyframes dropIn{from{opacity:0;transform:translateY(28px) scale(.8)}to{opacity:1;transform:translateY(0) scale(1)}}
.drop-item:nth-child(1){animation-delay:.1s}.drop-item:nth-child(2){animation-delay:.25s}.drop-item:nth-child(3){animation-delay:.4s}
.drop-icon{font-size:2.3rem;}
.drop-name{font-size:.62rem;font-family:'Orbitron',sans-serif;text-align:center;line-height:1.3;}
.drop-rtag{font-size:.52rem;text-transform:uppercase;letter-spacing:.1em;padding:2px 7px;border-radius:2px;}
.drop-continue{padding:9px 26px;font-family:'Orbitron',sans-serif;font-size:.68rem;
  letter-spacing:.14em;text-transform:uppercase;background:rgba(168,85,247,.12);
  border:1px solid var(--purple);color:var(--purple);cursor:pointer;border-radius:2px;
  transition:all .2s;margin-top:6px;}
.drop-continue:hover{background:rgba(168,85,247,.32);}

/* TOAST */
.toast{position:fixed;top:14px;right:14px;padding:8px 15px;
  background:var(--s2);border:1px solid var(--gold);border-radius:2px;
  font-size:.65rem;color:var(--gold);z-index:1000;
  animation:toastIn .3s ease,toastOut .3s ease 2.2s forwards;
  font-family:'Orbitron',sans-serif;letter-spacing:.07em;max-width:260px;}
.toast.toast-rebirth{border-color:var(--purple);color:var(--purple);}
.toast.toast-buy{border-color:var(--green);color:var(--green);}
@keyframes toastIn{from{opacity:0;transform:translateX(18px)}to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{from{opacity:1}to{opacity:0}}

/* ‚îÄ‚îÄ MARKETPLACE PAGE ‚îÄ‚îÄ */
.market-page{padding:0;}
.market-toolbar{display:flex;align-items:center;gap:10px;padding:12px 16px;
  border-bottom:1px solid var(--border);background:var(--s1);flex-wrap:wrap;}
.market-toolbar h2{font-family:'Orbitron',sans-serif;font-size:.82rem;font-weight:700;
  color:var(--purple);letter-spacing:.12em;text-transform:uppercase;margin-right:auto;}
.token-badge{display:flex;align-items:center;gap:6px;background:rgba(168,85,247,.1);
  border:1px solid rgba(168,85,247,.35);border-radius:3px;padding:5px 10px;}
.token-badge .tk-icon{font-size:1rem;}
.token-badge .tk-val{font-family:'Orbitron',sans-serif;font-size:.8rem;color:var(--purple);font-weight:700;}
.token-badge .tk-lbl{font-size:.5rem;color:var(--muted);text-transform:uppercase;}
.market-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--s2);}
.market-tab{flex:1;padding:7px;font-family:'Orbitron',sans-serif;font-size:.58rem;letter-spacing:.08em;
  text-transform:uppercase;background:transparent;border:none;border-bottom:2px solid transparent;
  color:var(--muted);cursor:pointer;transition:all .2s;}
.market-tab.active{color:var(--purple);border-bottom-color:var(--purple);}
.market-section{display:none;padding:14px 16px;}
.market-section.active{display:block;}

/* Leaderboard */
.lb-row{display:flex;align-items:center;gap:10px;padding:9px 12px;
  background:var(--s2);border:1px solid var(--border);border-radius:2px;margin-bottom:5px;transition:all .2s;}
.lb-row.lb-me{border-color:var(--blue);background:rgba(0,207,255,.04);}
.lb-rank{font-family:'Orbitron',sans-serif;font-size:.72rem;font-weight:700;width:24px;text-align:center;color:var(--muted);}
.lb-rank.gold{color:var(--gold)}.lb-rank.silver{color:#aaa}.lb-rank.bronze{color:#cd7f32}
.lb-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;border:2px solid var(--border);}
.lb-name{flex:1;font-size:.68rem;color:var(--text);}
.lb-name small{display:block;font-size:.52rem;color:var(--muted);margin-top:1px;}
.lb-prestige{font-family:'Orbitron',sans-serif;font-size:.7rem;color:var(--purple);}
.lb-prestige span{font-size:.52rem;color:var(--muted);}
.lb-you-tag{font-size:.5rem;background:rgba(0,207,255,.15);color:var(--blue);
  border:1px solid rgba(0,207,255,.3);padding:1px 5px;border-radius:2px;margin-left:4px;}

/* Player Listings */
.listing-filters{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;}
.filter-btn{padding:4px 10px;font-family:'Orbitron',sans-serif;font-size:.54rem;letter-spacing:.07em;
  text-transform:uppercase;cursor:pointer;border-radius:2px;border:1px solid var(--border);
  background:var(--s2);color:var(--muted);transition:all .2s;}
.filter-btn.active{border-color:var(--blue);color:var(--blue);background:rgba(0,207,255,.08);}
.listings-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;}
.listing-card{background:var(--s2);border:1px solid var(--border);border-radius:3px;padding:11px;
  transition:all .2s;position:relative;overflow:hidden;}
.listing-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;}
.listing-card:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.4);}
.lc-seller{display:flex;align-items:center;gap:6px;margin-bottom:8px;font-size:.56rem;color:var(--muted);}
.lc-seller-name{color:var(--text);}
.lc-seller-rb{background:rgba(168,85,247,.1);color:var(--purple);border:1px solid rgba(168,85,247,.2);
  padding:1px 5px;border-radius:2px;font-size:.5rem;margin-left:auto;}
.lc-item{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.lc-icon{font-size:1.6rem;}
.lc-item-info .lc-name{font-family:'Orbitron',sans-serif;font-size:.62rem;color:var(--text);}
.lc-item-info .lc-rarity{font-size:.52rem;text-transform:uppercase;letter-spacing:.08em;margin-top:1px;}
.lc-item-info .lc-stats{font-size:.52rem;color:var(--green);margin-top:2px;}
.lc-price{display:flex;align-items:center;justify-content:space-between;margin-top:6px;}
.lc-price-val{font-family:'Orbitron',sans-serif;font-size:.72rem;}
.lc-price-val.coins{color:var(--gold);}
.lc-price-val.tokens{color:var(--purple);}
.lc-buy-btn{padding:5px 10px;font-family:'Orbitron',sans-serif;font-size:.55rem;letter-spacing:.07em;
  text-transform:uppercase;cursor:pointer;border-radius:2px;transition:all .2s;}
.lc-buy-btn.coins{background:rgba(255,215,0,.1);border:1px solid var(--gold);color:var(--gold);}
.lc-buy-btn.coins:hover{background:rgba(255,215,0,.25);}
.lc-buy-btn.coins:disabled{opacity:.3;cursor:not-allowed;}
.lc-buy-btn.tokens{background:rgba(168,85,247,.1);border:1px solid var(--purple);color:var(--purple);}
.lc-buy-btn.tokens:hover{background:rgba(168,85,247,.25);}
.lc-buy-btn.tokens:disabled{opacity:.3;cursor:not-allowed;}
.lc-my-badge{position:absolute;top:7px;right:7px;font-size:.5rem;background:rgba(0,207,255,.15);
  color:var(--blue);border:1px solid rgba(0,207,255,.3);padding:2px 5px;border-radius:2px;}
.no-listings{text-align:center;padding:40px;color:var(--muted);font-size:.7rem;
  border:1px dashed var(--border);border-radius:3px;}

/* Rebirth Feed */
.feed-item{display:flex;align-items:center;gap:10px;padding:9px 12px;
  background:var(--s2);border:1px solid var(--border);border-radius:2px;margin-bottom:5px;
  animation:feedIn .4s ease;}
@keyframes feedIn{from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:translateX(0)}}
.feed-avatar{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:.85rem;border:1px solid var(--purple);background:rgba(168,85,247,.1);}
.feed-text{flex:1;font-size:.62rem;color:var(--text);line-height:1.5;}
.feed-text strong{color:var(--purple);}
.feed-text .feed-items-row{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap;}
.feed-item-tag{font-size:.5rem;padding:1px 5px;border-radius:2px;border:1px solid;}
.feed-time{font-size:.52rem;color:var(--muted);}
.feed-empty{text-align:center;padding:40px;color:var(--muted);font-size:.7rem;
  border:1px dashed var(--border);border-radius:3px;}

/* My Listings */
.my-listing-card{display:flex;align-items:center;gap:10px;padding:9px 12px;
  background:var(--s2);border:1px solid var(--border);border-radius:2px;margin-bottom:5px;}
.mlc-icon{font-size:1.4rem;}
.mlc-info{flex:1;}
.mlc-name{font-size:.65rem;color:var(--text);}
.mlc-price{font-size:.58rem;color:var(--gold);margin-top:2px;}
.mlc-price.tokens{color:var(--purple);}
.mlc-cancel{padding:4px 9px;font-family:'Orbitron',sans-serif;font-size:.54rem;letter-spacing:.06em;
  text-transform:uppercase;cursor:pointer;border-radius:2px;background:rgba(255,68,102,.1);
  border:1px solid var(--red);color:var(--red);transition:all .2s;}
.mlc-cancel:hover{background:rgba(255,68,102,.25);}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.section-header h3{font-family:'Orbitron',sans-serif;font-size:.68rem;color:var(--text);letter-spacing:.12em;text-transform:uppercase;}
.refresh-btn{padding:4px 9px;font-size:.54rem;font-family:'Orbitron',sans-serif;cursor:pointer;
  border-radius:2px;border:1px solid var(--border);background:var(--s2);color:var(--muted);transition:all .2s;text-transform:uppercase;letter-spacing:.06em;}
.refresh-btn:hover{border-color:var(--blue);color:var(--blue);}

/* Auth modal */
.auth-modal{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:500;
  display:flex;align-items:center;justify-content:center;}
.auth-box{background:var(--s2);border:1px solid var(--purple);border-radius:4px;
  padding:28px 30px;max-width:360px;width:92%;text-align:center;}
.auth-box h2{font-family:'Orbitron',sans-serif;font-size:1rem;color:var(--purple);letter-spacing:.12em;margin-bottom:4px;}
.auth-box .auth-sub{font-size:.62rem;color:var(--muted);margin-bottom:18px;line-height:1.7;}
.auth-tabs{display:flex;gap:0;margin-bottom:20px;border:1px solid var(--border);border-radius:2px;overflow:hidden;}
.auth-tab{flex:1;padding:8px;font-family:'Orbitron',sans-serif;font-size:.6rem;letter-spacing:.08em;
  text-transform:uppercase;cursor:pointer;background:var(--s1);border:none;color:var(--muted);transition:all .2s;}
.auth-tab.active{background:rgba(168,85,247,.2);color:var(--purple);}
.auth-form{display:flex;flex-direction:column;gap:8px;}
.auth-input{width:100%;background:var(--s1);border:1px solid var(--border);color:var(--text);
  font-family:'Share Tech Mono',monospace;font-size:.82rem;padding:9px 12px;border-radius:2px;
  outline:none;text-align:left;}
.auth-input:focus{border-color:var(--purple);}
.auth-input::placeholder{color:var(--muted);}
.auth-btn{width:100%;padding:10px;font-family:'Orbitron',sans-serif;font-size:.68rem;
  letter-spacing:.1em;text-transform:uppercase;cursor:pointer;border-radius:2px;
  background:rgba(168,85,247,.15);border:1px solid var(--purple);color:var(--purple);transition:all .2s;margin-top:4px;}
.auth-btn:hover{background:rgba(168,85,247,.3);}
.auth-error{font-size:.62rem;color:var(--red);background:rgba(255,68,102,.08);
  border:1px solid rgba(255,68,102,.25);border-radius:2px;padding:7px;display:none;}
.auth-error.show{display:block;}
.avatar-pick{display:flex;gap:8px;justify-content:center;margin-bottom:4px;flex-wrap:wrap;}
.av-opt{font-size:1.4rem;cursor:pointer;padding:6px;border-radius:50%;border:2px solid var(--border);
  transition:all .2s;}
.av-opt.selected{border-color:var(--purple);background:rgba(168,85,247,.2);}
.av-pick-label{font-size:.56rem;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.1em;}

@media(max-width:580px){
  .game{grid-template-columns:1fr;}
  .shop{max-height:44vh;}
  .listings-grid{grid-template-columns:1fr;}
}

/* Firebase setup modal */
.fb-setup{position:fixed;inset:0;background:rgba(0,0,0,.96);z-index:900;
  display:flex;align-items:center;justify-content:center;padding:16px;}
.fb-box{background:var(--s2);border:1px solid var(--blue);border-radius:4px;
  padding:26px 28px;max-width:480px;width:100%;}
.fb-box h2{font-family:'Orbitron',sans-serif;font-size:.9rem;color:var(--blue);letter-spacing:.12em;margin-bottom:6px;}
.fb-box p{font-size:.63rem;color:var(--muted);line-height:1.8;margin-bottom:14px;}
.fb-box ol{font-size:.63rem;color:var(--muted);line-height:2;padding-left:18px;margin-bottom:14px;}
.fb-box ol li{margin-bottom:2px;}
.fb-box ol li a{color:var(--blue);}
.fb-input{width:100%;background:var(--s1);border:1px solid var(--border);color:var(--text);
  font-family:'Share Tech Mono',monospace;font-size:.72rem;padding:8px 10px;border-radius:2px;
  outline:none;margin-bottom:7px;}
.fb-input:focus{border-color:var(--blue);}
.fb-input::placeholder{color:var(--muted);}
.fb-btn{width:100%;padding:10px;font-family:'Orbitron',sans-serif;font-size:.65rem;
  letter-spacing:.1em;text-transform:uppercase;cursor:pointer;border-radius:2px;
  background:rgba(0,207,255,.12);border:1px solid var(--blue);color:var(--blue);transition:all .2s;margin-top:4px;}
.fb-btn:hover{background:rgba(0,207,255,.28);}
.fb-err{font-size:.62rem;color:var(--red);margin-top:6px;display:none;}
.fb-err.show{display:block;}
.fb-note{font-size:.58rem;color:var(--muted);margin-top:10px;padding:8px;background:rgba(0,207,255,.04);border-radius:2px;border:1px solid var(--border);line-height:1.7;}
</style>
</head>
<body>

<!-- Firebase Setup Modal -->
<div class="fb-setup" id="fb-setup" style="display:none">
  <div class="fb-box">
    <h2>üî• FIREBASE SETUP</h2>
    <p>–ó–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏ multiplayer-—ä—Ç, —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–≤—ä—Ä–∂–µ—à –∏–≥—Ä–∞—Ç–∞ —Å Firebase.<br>–°–ª–µ–¥–≤–∞–π —Å—Ç—ä–ø–∫–∏—Ç–µ ‚Äî –æ—Ç–Ω–µ–º–∞ ~3 –º–∏–Ω—É—Ç–∏ –∏ –µ –Ω–∞–ø—ä–ª–Ω–æ –±–µ–∑–ø–ª–∞—Ç–Ω–æ.</p>
    <ol>
      <li>–û—Ç–∏–¥–∏ –Ω–∞ <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a></li>
      <li>–°—ä–∑–¥–∞–π –Ω–æ–≤ –ø—Ä–æ–µ–∫—Ç (–∏–ª–∏ –∏–∑–ø–æ–ª–∑–≤–∞–π —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â)</li>
      <li>–ö–ª–∏–∫–Ω–∏ ‚öôÔ∏è ‚Üí <strong>Project settings</strong> ‚Üí <strong>Your apps</strong> ‚Üí –¥–æ–±–∞–≤–∏ Web app (&lt;/&gt;)</li>
      <li>–ö–æ–ø–∏—Ä–∞–π <strong>firebaseConfig</strong> —Å—Ç–æ–π–Ω–æ—Å—Ç–∏—Ç–µ –ø–æ-–¥–æ–ª—É</li>
      <li>–í –ª—è–≤–æ—Ç–æ –º–µ–Ω—é ‚Üí <strong>Realtime Database</strong> ‚Üí Create database ‚Üí <em>Start in test mode</em></li>
    </ol>
    <input class="fb-input" id="fb-apiKey" placeholder="apiKey: &quot;AIza...&quot;"/>
    <input class="fb-input" id="fb-projectId" placeholder="projectId: &quot;my-project-123&quot;"/>
    <input class="fb-input" id="fb-dbUrl" placeholder="databaseURL: &quot;https://my-project-default-rtdb.firebaseio.com&quot;"/>
    <div class="fb-err" id="fb-err">–ú–æ–ª—è –ø–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!</div>
    <button class="fb-btn" onclick="initFirebase()">üî• –°–í–™–†–ñ–ò FIREBASE</button>
    <div class="fb-note">üí° –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ —Å–µ –∑–∞–ø–∞–∑–≤–∞ –≤ localStorage ‚Äî —Å–ª–µ–¥–≤–∞—â–∏—è –ø—ä—Ç —â–µ —Å–µ –∑–∞—Ä–µ–¥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.</div>
  </div>
</div>

<!-- Auth modal -->
<div class="auth-modal" id="auth-modal" style="display:none">
  <div class="auth-box">
    <h2>‚õè CRYPTOMINER</h2>
    <p class="auth-sub">Mine ‚Ä¢ Rebirth ‚Ä¢ Trade</p>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-login" onclick="switchAuthTab('login')">–í—Ö–æ–¥</button>
      <button class="auth-tab" id="tab-register" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <!-- LOGIN FORM -->
    <div id="form-login" class="auth-form">
      <input class="auth-input" id="login-user" placeholder="–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ" maxlength="16" autocomplete="username"/>
      <input class="auth-input" id="login-pass" type="password" placeholder="–ü–∞—Ä–æ–ª–∞" autocomplete="current-password"/>
      <div class="auth-error" id="login-err"></div>
      <button class="auth-btn" onclick="doLogin()">‚õè –í–õ–ï–ó</button>
    </div>

    <!-- REGISTER FORM -->
    <div id="form-register" class="auth-form" style="display:none">
      <div class="av-pick-label">–ò–∑–±–µ—Ä–∏ –∞–≤–∞—Ç–∞—Ä</div>
      <div class="avatar-pick" id="avatar-pick">
        <div class="av-opt selected" data-av="üßë">üßë</div>
        <div class="av-opt" data-av="ü§†">ü§†</div>
        <div class="av-opt" data-av="ü§ñ">ü§ñ</div>
        <div class="av-opt" data-av="üëæ">üëæ</div>
        <div class="av-opt" data-av="üßô">üßô</div>
        <div class="av-opt" data-av="ü¶Ö">ü¶Ö</div>
        <div class="av-opt" data-av="üê∫">üê∫</div>
        <div class="av-opt" data-av="ü¶Ñ">ü¶Ñ</div>
      </div>
      <input class="auth-input" id="reg-user" placeholder="–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ (2-16 –±—É–∫–≤–∏)" maxlength="16" autocomplete="username"/>
      <input class="auth-input" id="reg-pass" type="password" placeholder="–ü–∞—Ä–æ–ª–∞ (–º–∏–Ω. 4 —Å–∏–º–≤–æ–ª–∞)" autocomplete="new-password"/>
      <input class="auth-input" id="reg-pass2" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏ –ø–∞—Ä–æ–ª–∞—Ç–∞" autocomplete="new-password"/>
      <div class="auth-error" id="reg-err"></div>
      <button class="auth-btn" onclick="doRegister()">‚õè –†–ï–ì–ò–°–¢–†–ò–†–ê–ô</button>
    </div>
  </div>
</div>

<header>
  <h1>&#x20BF; CRYPTOMINER</h1>
  <p id="header-sub">Mine &#x2022; Rebirth &#x2022; Trade</p>
</header>
<div class="nav-tabs">
  <button class="nav-tab active" onclick="showPage('game',this)">&#x26CF; Mine</button>
  <button class="nav-tab" onclick="showPage('items',this)">&#x1F392; Items</button>
  <button class="nav-tab" onclick="showPage('market',this)" id="market-nav-btn">&#x1F6D2; Market</button>
</div>

<!-- GAME PAGE -->
<div id="page-game" class="page active">
<div class="game">
  <div class="center">
    <div style="text-align:center;margin-bottom:4px">
      <div class="balance-amount" id="balance">0</div>
      <div class="balance-label">&#x20BF; COINS MINED</div>
      <div class="per-sec" id="per-sec">+0 coins/sec</div>
    </div>
    <div class="coin-wrap">
      <button class="coin-btn" id="coinBtn" onclick="clickCoin(event)">&#x20BF;</button>
    </div>
    <div class="click-info">
      <span>&#x26A1; Power: <strong id="click-power">1</strong></span>
      <span>&#x23F1; Level: <strong id="level-num">1</strong></span>
    </div>
    <div class="level-wrap">
      <div class="level-label"><span>Lv <span id="lvl-cur">1</span></span><span id="lvl-prog">0/100</span></div>
      <div class="level-bar"><div class="level-fill" id="lvl-bar" style="width:0%"></div></div>
    </div>
    <div class="stats-grid">
      <div class="stat-box"><div class="val" id="stat-total">0</div><div class="lbl">Total Mined</div></div>
      <div class="stat-box"><div class="val" id="stat-clicks">0</div><div class="lbl">Clicks</div></div>
      <div class="stat-box"><div class="val" id="stat-cps">0</div><div class="lbl">Coins/Sec</div></div>
      <div class="stat-box"><div class="val" id="stat-prestige">0</div><div class="lbl">Rebirths</div></div>
    </div>
    <div class="eq-strip-wrap">
      <div class="eq-strip-title">&#x2694; Equipped &nbsp;<span id="token-strip" style="color:var(--purple);font-size:.58rem;">&#x1FA99; 0 tokens</span></div>
      <div class="eq-strip" id="eq-strip"></div>
    </div>
    <button class="prestige-btn" id="prestige-btn" onclick="doRebirth()" disabled>
      &#x267B; REBIRTH (1M coins) &#x2014; items + tokens!
    </button>
    <div class="achievements">
      <div class="ach-title">Achievements</div>
      <div class="ach" id="ach-0">&#x1F91C;</div>
      <div class="ach" id="ach-1">&#x1FA99;</div>
      <div class="ach" id="ach-2">&#x26A1;</div>
      <div class="ach" id="ach-3">&#x1F680;</div>
      <div class="ach" id="ach-4">&#x1F31F;</div>
      <div class="ach" id="ach-5">&#x1F4AA;</div>
    </div>
  </div>
  <div class="shop">
    <div class="shop-title">&#x1F6D2; Shop</div>
    <div id="shop-items"></div>
  </div>
</div>
</div>

<!-- ITEMS PAGE -->
<div id="page-items" class="page">
<div class="items-page">
  <h2>&#x1F392; Equipment</h2>
  <div class="subtitle">Items drop on Rebirth. Click to equip or list in Marketplace.</div>
  <div class="section-title">&#x2694; Equipped (5 slots)</div>
  <div class="equip-grid" id="equip-slots"></div>
  <div class="section-title">&#x1F4E6; Inventory (<span id="inv-count">0</span>)</div>
  <div class="inventory-grid" id="inventory-grid"></div>
</div>
</div>

<!-- MARKETPLACE PAGE -->
<div id="page-market" class="page">
  <div class="market-toolbar">
    <h2>&#x1F6D2; Marketplace</h2>
    <div class="token-badge">
      <div class="tk-icon">&#x1FA99;</div>
      <div>
        <div class="tk-val" id="market-token-display">0</div>
        <div class="tk-lbl">Tokens</div>
      </div>
    </div>
  </div>
  <div class="market-tabs">
    <button class="market-tab active" onclick="switchMarketTab('listings',this)">&#x1F3EA; Listings</button>
    <button class="market-tab" onclick="switchMarketTab('leaderboard',this)">&#x1F3C6; Leaderboard</button>
    <button class="market-tab" onclick="switchMarketTab('feed',this)">&#x26A1; Rebirth Feed <span id="feed-badge" class="tab-badge" style="display:none">!</span></button>
    <button class="market-tab" onclick="switchMarketTab('mylistings',this)">&#x1F4CB; My Listings</button>
  </div>

  <!-- Listings -->
  <div id="market-listings" class="market-section active">
    <div class="section-header">
      <h3>&#x1F6CD; Player Listings</h3>
      <button class="refresh-btn" onclick="loadListings()">&#x21BB; Refresh</button>
    </div>
    <div class="listing-filters" id="listing-filters">
      <button class="filter-btn active" data-filter="all" onclick="setFilter('all',this)">All</button>
      <button class="filter-btn" data-filter="coins" onclick="setFilter('coins',this)">&#x20BF; Coins</button>
      <button class="filter-btn" data-filter="tokens" onclick="setFilter('tokens',this)">&#x1FA99; Tokens</button>
      <button class="filter-btn" data-filter="common" onclick="setFilter('common',this)">Common</button>
      <button class="filter-btn" data-filter="rare" onclick="setFilter('rare',this)">Rare</button>
      <button class="filter-btn" data-filter="epic" onclick="setFilter('epic',this)">Epic</button>
      <button class="filter-btn" data-filter="legendary" onclick="setFilter('legendary',this)">Legendary</button>
    </div>
    <div class="listings-grid" id="listings-grid"><div class="no-listings">Loading...</div></div>
  </div>

  <!-- Leaderboard -->
  <div id="market-leaderboard" class="market-section">
    <div class="section-header">
      <h3>&#x1F3C6; Rebirth Leaderboard</h3>
      <button class="refresh-btn" onclick="loadLeaderboard()">&#x21BB; Refresh</button>
    </div>
    <div id="leaderboard-list"></div>
  </div>

  <!-- Rebirth Feed -->
  <div id="market-feed" class="market-section">
    <div class="section-header">
      <h3>&#x26A1; Rebirth Activity</h3>
      <button class="refresh-btn" onclick="loadFeed()">&#x21BB; Refresh</button>
    </div>
    <div id="feed-list"></div>
  </div>

  <!-- My Listings -->
  <div id="market-mylistings" class="market-section">
    <div class="section-header">
      <h3>&#x1F4CB; My Active Listings</h3>
      <button class="refresh-btn" onclick="loadMyListings()">&#x21BB; Refresh</button>
    </div>
    <div id="my-listings-list"></div>
  </div>
</div>

<!-- Item Modal -->
<div class="modal-overlay" id="modal" style="display:none" onclick="closeModal(event)">
  <div class="modal">
    <div class="modal-icon" id="m-icon"></div>
    <div class="modal-name" id="m-name"></div>
    <div class="modal-rarity" id="m-rarity"></div>
    <div class="modal-desc" id="m-desc"></div>
    <div class="modal-stats" id="m-stats"></div>
    <div id="m-sell-area"></div>
    <div class="modal-btns" id="m-btns"></div>
  </div>
</div>

<!-- Drop screen -->
<div class="drop-overlay" id="drop-overlay" style="display:none">
  <div class="drop-title">&#x2728; REBIRTH COMPLETE</div>
  <div class="drop-subtitle">Items Received:</div>
  <div class="drop-items" id="drop-items"></div>
  <div class="drop-token-reward" id="drop-token-reward"></div>
  <button class="drop-continue" onclick="closeDrop()">Continue &#x2192;</button>
</div>

<script>
// ‚îÄ‚îÄ RARITIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RARITIES = {
  common:    {name:'Common',    color:'#a0a0c0'},
  rare:      {name:'Rare',      color:'#4488ff'},
  epic:      {name:'Epic',      color:'#cc44ff'},
  legendary: {name:'Legendary', color:'#ff9900'},
};
const RARITY_ORDER = ['common','rare','epic','legendary'];

// ‚îÄ‚îÄ ITEM POOL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ITEMS = [
  {id:'h1',type:'helmet', icon:'‚õëÔ∏è', name:'Miner Helmet',  rarity:'common',   desc:'Basic hard hat.',               stats:{cp:1}},
  {id:'h2',type:'helmet', icon:'ü™¶', name:'Steel Helm',    rarity:'rare',     desc:'Reinforced mining helmet.',     stats:{cp:3,  cb:.05}},
  {id:'h3',type:'helmet', icon:'üëë', name:'Golden Crown',  rarity:'epic',     desc:'Crown of the mine king.',       stats:{cp:8,  cb:.12}},
  {id:'h4',type:'helmet', icon:'üåü', name:'Crypto Crown',  rarity:'legendary',desc:'Forged from pure Bitcoin.',     stats:{cp:20, cb:.30}},
  {id:'p1',type:'pickaxe',icon:'‚õèÔ∏è', name:'Stone Pick',    rarity:'common',   desc:'Better than bare hands.',       stats:{cp:2}},
  {id:'p2',type:'pickaxe',icon:'üî®', name:'Iron Pickaxe',  rarity:'rare',     desc:'Sturdy iron tool.',             stats:{cp:5,  cb:.08}},
  {id:'p3',type:'pickaxe',icon:'ü™ì', name:'Diamond Pick',  rarity:'epic',     desc:'Cuts through anything.',        stats:{cp:12, cb:.18}},
  {id:'p4',type:'pickaxe',icon:'‚ö°', name:'Laser Drill',   rarity:'legendary',desc:'Vaporizes blocks instantly.',   stats:{cp:30, cb:.40}},
  {id:'r1',type:'ring',   icon:'üíç', name:'Copper Ring',   rarity:'common',   desc:'Small mining bonus.',           stats:{cb:.03}},
  {id:'r2',type:'ring',   icon:'üîÆ', name:'Magic Ring',    rarity:'rare',     desc:'Enchanted with hash power.',    stats:{cp:2,  cb:.10}},
  {id:'r3',type:'ring',   icon:'üíé', name:'Diamond Ring',  rarity:'epic',     desc:'Boosts all mining rates.',      stats:{cp:5,  cb:.20}},
  {id:'r4',type:'ring',   icon:'üåà', name:'Infinity Ring', rarity:'legendary',desc:'Endless crypto power.',         stats:{cp:15, cb:.50}},
  {id:'b1',type:'boots',  icon:'üëü', name:'Work Boots',    rarity:'common',   desc:'Comfy for long shifts.',        stats:{cb:.02}},
  {id:'b2',type:'boots',  icon:'ü•æ', name:'Speed Boots',   rarity:'rare',     desc:'Mine faster on your feet.',     stats:{cp:1,  cb:.07}},
  {id:'b3',type:'boots',  icon:'üöÄ', name:'Rocket Boots',  rarity:'epic',     desc:'Fly to new mining zones.',      stats:{cp:4,  cb:.15}},
  {id:'b4',type:'boots',  icon:'‚öôÔ∏è', name:'Mech Boots',    rarity:'legendary',desc:'Cybernetic enhancement.',       stats:{cp:12, cb:.35}},
  {id:'c1',type:'chest',  icon:'üëï', name:'Mining Vest',   rarity:'common',   desc:'Carries your tools.',           stats:{cp:1,  cb:.02}},
  {id:'c2',type:'chest',  icon:'üß•', name:'Iron Plate',    rarity:'rare',     desc:'Heavy duty protection.',        stats:{cp:4,  cb:.09}},
  {id:'c3',type:'chest',  icon:'üõ°Ô∏è', name:'Dragon Armor',  rarity:'epic',     desc:'Scales from the Hash Dragon.',  stats:{cp:10, cb:.20}},
  {id:'c4',type:'chest',  icon:'üåë', name:'Void Armor',    rarity:'legendary',desc:'Absorbs all energy.',           stats:{cp:25, cb:.45}},
];
const SLOT_TYPES  = ['helmet','pickaxe','ring','boots','chest'];
const SLOT_ICONS  = {helmet:'‚õëÔ∏è',pickaxe:'‚õèÔ∏è',ring:'üíç',boots:'üëü',chest:'üëï'};

// ‚îÄ‚îÄ UPGRADES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const UPGRADES = [
  {id:'cursor',    icon:'üñ±Ô∏è', name:'Auto Cursor',    desc:'Clicks for you.',           baseCost:15,     baseCps:.1,  baseClick:0},
  {id:'miner',     icon:'‚õèÔ∏è', name:'CPU Miner',      desc:'Background mining.',        baseCost:100,    baseCps:.5,  baseClick:0},
  {id:'gpu',       icon:'üíª', name:'GPU Farm',       desc:'Graphics card array.',      baseCost:500,    baseCps:2,   baseClick:0},
  {id:'asic',      icon:'üîß', name:'ASIC Rig',       desc:'Dedicated hardware.',       baseCost:2000,   baseCps:8,   baseClick:0},
  {id:'pool',      icon:'üåê', name:'Mining Pool',    desc:'Pooled income.',            baseCost:8000,   baseCps:25,  baseClick:0},
  {id:'gloves',    icon:'ü•ä', name:'Power Gloves',   desc:'+2 click power.',           baseCost:250,    baseCps:0,   baseClick:2},
  {id:'laser',     icon:'‚ö°', name:'Laser Fingers',  desc:'+5 click power.',           baseCost:3000,   baseCps:0,   baseClick:5},
  {id:'dc',        icon:'üè¢', name:'Data Center',    desc:'Massive server farm.',      baseCost:50000,  baseCps:100, baseClick:0},
  {id:'quantum',   icon:'üîÆ', name:'Quantum Miner',  desc:'Quantum computing.',        baseCost:200000, baseCps:400, baseClick:0},
  {id:'satellite', icon:'üõ∏', name:'Satellite',      desc:'Mine from orbit.',          baseCost:1000000,baseCps:2000,baseClick:0},
];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let G = {
  coins:0, totalCoins:0, clicks:0,
  clickPower:1, cps:0,
  level:1, levelXP:0,
  prestige:0,
  rebirthTokens:0,
  upgrades:{},
  achievements:new Set(),
  inventory:[],
  equipped:{helmet:null,pickaxe:null,ring:null,boots:null,chest:null},
  instances:{},
  nextId:1,
};
UPGRADES.forEach(u=>{G.upgrades[u.id]=0;});

let PLAYER_ID = '';
let PLAYER_NAME = '';
let PLAYER_AVATAR = 'üßë';
let currentFilter = 'all';
let currentModalInst = null;
let sellCurrency = 'coins';
let feedUnread = 0;

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmt(n){
  if(n>=1e12)return(n/1e12).toFixed(2)+'T';
  if(n>=1e9) return(n/1e9).toFixed(2)+'B';
  if(n>=1e6) return(n/1e6).toFixed(2)+'M';
  if(n>=1e3) return(n/1e3).toFixed(1)+'K';
  return Math.floor(n)+'';
}
function upgCost(u){return Math.floor(u.baseCost*Math.pow(1.15,G.upgrades[u.id]));}
function lvlThresh(l){return Math.floor(100*Math.pow(1.5,l-1));}
function rc(r){return RARITIES[r].color;}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6);}
function timeAgo(ts){
  const d=Date.now()-ts;
  if(d<60000)return Math.floor(d/1000)+'s ago';
  if(d<3600000)return Math.floor(d/60000)+'m ago';
  if(d<86400000)return Math.floor(d/3600000)+'h ago';
  return Math.floor(d/86400000)+'d ago';
}
function tokenReward(prestige){
  if(prestige<=5)return 1;
  if(prestige<=15)return 2;
  return 3;
}

function eqBonuses(){
  let cp=0,cb=0;
  Object.values(G.equipped).forEach(id=>{
    if(!id)return;
    const inst=G.instances[id];if(!inst)return;
    const item=ITEMS.find(x=>x.id===inst.itemId);if(!item)return;
    cp+=(item.stats.cp||0); cb+=(item.stats.cb||0);
  });
  return{cp,cb};
}

function recalc(){
  let cps=0,cp=1;
  UPGRADES.forEach(u=>{cps+=u.baseCps*G.upgrades[u.id];cp+=u.baseClick*G.upgrades[u.id];});
  const pb=1+G.prestige*.5;
  const eq=eqBonuses();
  G.cps=cps*pb*(1+eq.cb);
  G.clickPower=(cp+eq.cp)*pb;
}

// ‚îÄ‚îÄ AUTH SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.av-opt').forEach(el=>{
  el.onclick=()=>{
    document.querySelectorAll('.av-opt').forEach(e=>e.classList.remove('selected'));
    el.classList.add('selected');
  };
});

function switchAuthTab(tab){
  document.getElementById('form-login').style.display=tab==='login'?'flex':'none';
  document.getElementById('form-register').style.display=tab==='register'?'flex':'none';
  document.getElementById('tab-login').classList.toggle('active',tab==='login');
  document.getElementById('tab-register').classList.toggle('active',tab==='register');
}

// Simple hash (not cryptographic, just obfuscation for client-side)
async function hashPass(pass){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(pass));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

function showAuthErr(id, msg){
  const el=document.getElementById(id);
  el.textContent=msg;el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),3500);
}

async function doLogin(){
  const user=document.getElementById('login-user').value.trim();
  const pass=document.getElementById('login-pass').value;
  if(!user||!pass){showAuthErr('login-err','–ü–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!');return;}
  
  const stored=await safeGet('account:'+user.toLowerCase(), false);
  if(!stored){showAuthErr('login-err','–ù—è–º–∞ –∞–∫–∞—É–Ω—Ç —Å —Ç–æ–≤–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ.');return;}
  
  const hash=await hashPass(pass);
  if(hash!==stored.passwordHash){showAuthErr('login-err','–ì—Ä–µ—à–Ω–∞ –ø–∞—Ä–æ–ª–∞!');return;}
  
  PLAYER_NAME=stored.name;
  PLAYER_AVATAR=stored.avatar;
  PLAYER_ID=stored.playerId;
  
  // Load game state from Firebase
  const gs=await fbGet('accounts/'+slugify(PLAYER_NAME)+'/gameState');
  if(gs) restoreGameState(gs);
  
  // Save session for auto-login
  localStorage.setItem('cm_session',JSON.stringify({name:PLAYER_NAME,avatar:PLAYER_AVATAR,playerId:PLAYER_ID}));
  
  finishAuth();
}

async function doRegister(){
  const user=document.getElementById('reg-user').value.trim();
  const pass=document.getElementById('reg-pass').value;
  const pass2=document.getElementById('reg-pass2').value;
  const avatar=document.querySelector('.av-opt.selected')?.dataset.av||'üßë';
  
  if(!user||user.length<2){showAuthErr('reg-err','–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ—Ç–æ –∏–º–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –ø–æ–Ω–µ 2 —Å–∏–º–≤–æ–ª–∞!');return;}
  if(!pass||pass.length<4){showAuthErr('reg-err','–ü–∞—Ä–æ–ª–∞—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –ø–æ–Ω–µ 4 —Å–∏–º–≤–æ–ª–∞!');return;}
  if(pass!==pass2){showAuthErr('reg-err','–ü–∞—Ä–æ–ª–∏—Ç–µ –Ω–µ —Å—ä–≤–ø–∞–¥–∞—Ç!');return;}
  if(!/^[a-zA-Z0-9_–∞-—è–ê-–Ø]+$/.test(user)){showAuthErr('reg-err','–°–∞–º–æ –±—É–∫–≤–∏, —Ü–∏—Ñ—Ä–∏ –∏ _ —Å–∞ –ø–æ–∑–≤–æ–ª–µ–Ω–∏!');return;}
  
  // Check if username taken
  const existing=await safeGet('account:'+user.toLowerCase(), false);
  if(existing){showAuthErr('reg-err','–¢–æ–≤–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ –µ –∑–∞–µ—Ç–æ!');return;}
  
  const hash=await hashPass(pass);
  const playerId='p_'+uid();
  
  await safeSet('account:'+user.toLowerCase(), {
    name: user,
    avatar: avatar,
    playerId: playerId,
    passwordHash: hash,
    createdAt: Date.now(),
    gameState: null
  }, false);
  
  PLAYER_NAME=user;
  PLAYER_AVATAR=avatar;
  PLAYER_ID=playerId;
  
  // Save session for auto-login
  localStorage.setItem('cm_session',JSON.stringify({name:PLAYER_NAME,avatar:PLAYER_AVATAR,playerId:PLAYER_ID}));
  
  finishAuth();
}

async function finishAuth(){
  document.getElementById('auth-modal').style.display='none';
  document.getElementById('header-sub').textContent='Mine ‚Ä¢ Rebirth ‚Ä¢ Trade ‚Äî '+PLAYER_NAME;
  recalc();renderShop();renderEqStrip();renderItemsPage();
  await syncPlayerData();
  loadListings();loadLeaderboard();loadFeed();
  setInterval(syncPlayerData, 15000);
  setInterval(checkFeedUpdates, 20000);
  setInterval(saveGameState, 30000); // Auto-save every 30s
}

async function saveGameState(){
  if(!PLAYER_ID||!PLAYER_NAME||!DB)return;
  const gs={
    coins:G.coins,
    totalCoins:G.totalCoins,
    clicks:G.clicks,
    level:G.level,
    levelXP:G.levelXP,
    prestige:G.prestige,
    rebirthTokens:G.rebirthTokens,
    upgrades:G.upgrades,
    inventory:G.inventory,
    instances:G.instances,
    equipped:G.equipped,
    nextId:G.nextId,
    achievements:[...G.achievements]
  };
  await fbSet('accounts/'+slugify(PLAYER_NAME)+'/gameState', gs);
}

// ‚îÄ‚îÄ FIREBASE INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let DB = null; // Firebase database reference

async function initFirebase(){
  const apiKey = document.getElementById('fb-apiKey').value.trim();
  const projectId = document.getElementById('fb-projectId').value.trim();
  const dbUrl = document.getElementById('fb-dbUrl').value.trim();
  if(!apiKey||!projectId||!dbUrl){
    const e=document.getElementById('fb-err');e.textContent='–ú–æ–ª—è –ø–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!';e.classList.add('show');return;
  }
  const cfg={apiKey,projectId,databaseURL:dbUrl,appId:'cryptominer'};
  localStorage.setItem('cm_firebase_cfg',JSON.stringify(cfg));
  await loadFirebase(cfg);
}

async function loadFirebase(cfg){
  try{
    // Dynamically load Firebase SDK
    const {initializeApp} = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
    const {getDatabase,ref,set,get,remove,query,orderByKey,startAt} = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js');
    
    const app = initializeApp(cfg, 'cryptominer');
    DB = getDatabase(app);
    window._fbRef=ref; window._fbSet=set; window._fbGet=get; window._fbRemove=remove;
    window._fbQuery=query; window._fbOrderByKey=orderByKey; window._fbStartAt=startAt;
    
    document.getElementById('fb-setup').style.display='none';
    
    // Check if auth modal needs to show
    const saved = localStorage.getItem('cm_session');
    if(saved){
      try{
        const s=JSON.parse(saved);
        PLAYER_NAME=s.name; PLAYER_AVATAR=s.avatar; PLAYER_ID=s.playerId;
        // Load game state
        const gs=await fbGet('accounts/'+slugify(PLAYER_NAME)+'/gameState');
        if(gs) restoreGameState(gs);
        await finishAuth();
        return;
      }catch(e){}
    }
    document.getElementById('auth-modal').style.display='flex';
  }catch(err){
    const e=document.getElementById('fb-err');
    e.textContent='–ì—Ä–µ—à–∫–∞: '+err.message;e.classList.add('show');
  }
}

function slugify(s){return s.toLowerCase().replace(/[^a-z0-9_]/g,'_');}

// Firebase CRUD helpers
async function fbGet(path){
  try{const r=await window._fbGet(window._fbRef(DB,path));return r.exists()?r.val():null;}
  catch(e){return null;}
}
async function fbSet(path,val){
  try{await window._fbSet(window._fbRef(DB,path),val);}catch(e){}
}
async function fbDel(path){
  try{await window._fbRemove(window._fbRef(DB,path));}catch(e){}
}

// ‚îÄ‚îÄ STORAGE HELPERS (now backed by Firebase) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// shared=true  ‚Üí Firebase (multiplayer data)
// shared=false ‚Üí localStorage (private account data)
async function safeGet(key, shared=false){
  if(!shared){
    try{const v=localStorage.getItem('cm_'+key);return v?JSON.parse(v):null;}catch(e){return null;}
  }
  if(!DB)return null;
  // key can be "listing:abc" (colon-separated) or a direct Firebase path
  const path=key.replace(/:/g,'/');
  return await fbGet(path);
}
async function safeSet(key, val, shared=false){
  if(!shared){
    try{localStorage.setItem('cm_'+key,JSON.stringify(val));}catch(e){}
    return;
  }
  if(!DB)return;
  const path=key.replace(/:/g,'/');
  await fbSet(path,val);
}
async function safeDel(key, shared=false){
  if(!shared){
    try{localStorage.removeItem('cm_'+key);}catch(e){}
    return;
  }
  if(!DB)return;
  const path=key.replace(/:/g,'/');
  await fbDel(path);
}
async function safeList(prefix, shared=false){
  if(!shared){
    try{
      const keys=Object.keys(localStorage).filter(k=>k.startsWith('cm_'+prefix)).map(k=>k.slice(3));
      return keys;
    }catch(e){return[];}
  }
  if(!DB)return[];
  // prefix like "listing:" ‚Üí Firebase path "listing"
  // Returns array of full key strings like ["listing/id1", "listing/id2"]
  const path=prefix.replace(/:$/,'');
  try{
    const r=await window._fbGet(window._fbRef(DB,path));
    if(!r.exists())return[];
    // Return keys in "prefix/id" format so safeGet(key) works
    return Object.keys(r.val()).map(k=>path+'/'+k);
  }catch(e){return[];}
}

function restoreGameState(gs){
  G.coins=gs.coins||0;
  G.totalCoins=gs.totalCoins||0;
  G.clicks=gs.clicks||0;
  G.level=gs.level||1;
  G.levelXP=gs.levelXP||0;
  G.prestige=gs.prestige||0;
  G.rebirthTokens=gs.rebirthTokens||0;
  G.upgrades=gs.upgrades||{};
  G.inventory=gs.inventory||[];
  G.instances=gs.instances||{};
  G.equipped=gs.equipped||{weapon:null,armor:null,ring:null,helmet:null,boots:null};
  G.nextId=gs.nextId||1;
  G.achievements=new Set(gs.achievements||[]);
  G.achievements.forEach(id=>{
    const el=document.getElementById('ach-'+id);
    if(el)el.classList.add('unlocked');
  });
}

// ‚îÄ‚îÄ SYNC PLAYER DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function syncPlayerData(){
  if(!PLAYER_ID)return;
  await safeSet('player:'+PLAYER_ID, {
    id:PLAYER_ID,
    name:PLAYER_NAME,
    avatar:PLAYER_AVATAR,
    prestige:G.prestige,
    cps:G.cps,
    level:G.level,
    lastSeen:Date.now()
  }, true);
}

// ‚îÄ‚îÄ ITEM DROPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rollRarity(rebirths){
  const b=Math.min(rebirths*2,20);
  const w={common:Math.max(55-b*1.5,20),rare:Math.min(28+b*.5,40),epic:Math.min(13+b*.7,28),legendary:Math.min(4+b*.3,12)};
  const total=Object.values(w).reduce((a,b)=>a+b,0);
  let roll=Math.random()*total;
  for(const[r,wt]of Object.entries(w)){roll-=wt;if(roll<=0)return r;}
  return'common';
}
function rollDrops(rebirths){
  const count=2+(Math.random()<Math.min(.1+rebirths*.05,.8)?1:0);
  const dropped=[];
  for(let i=0;i<count;i++){
    const rarity=rollRarity(rebirths);
    const pool=ITEMS.filter(x=>x.rarity===rarity);
    const item=pool[Math.floor(Math.random()*pool.length)];
    const id='i'+G.nextId++;
    G.instances[id]={itemId:item.id,id};
    G.inventory.push(id);
    dropped.push(id);
  }
  return dropped;
}

// ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function clickCoin(e){
  const earned=G.clickPower;
  G.coins+=earned;G.totalCoins+=earned;G.clicks++;G.levelXP+=earned;
  const el=document.createElement('div');
  el.className='float-text';el.textContent='+'+fmt(earned);
  el.style.left=(e.clientX-20)+'px';el.style.top=(e.clientY-20)+'px';
  document.body.appendChild(el);setTimeout(()=>el.remove(),800);
  const btn=document.getElementById('coinBtn');
  btn.classList.remove('clicked');void btn.offsetWidth;btn.classList.add('clicked');
  checkAch();checkLevel();
}

function buy(id){
  const u=UPGRADES.find(x=>x.id===id);
  const cost=upgCost(u);
  if(G.coins<cost)return;
  G.coins-=cost;G.upgrades[u.id]++;
  recalc();renderShop();checkAch();
  if(G.upgrades[u.id]===1)toast('Bought: '+u.name);
}

async function doRebirth(){
  if(G.totalCoins<1000000)return;
  G.prestige++;
  const tokens=tokenReward(G.prestige);
  G.rebirthTokens+=tokens;
  const dropped=rollDrops(G.prestige);
  G.coins=0;G.totalCoins=0;G.clicks=0;G.level=1;G.levelXP=0;
  UPGRADES.forEach(u=>{G.upgrades[u.id]=0;});
  recalc();renderShop();showDropScreen(dropped,tokens);checkAch();
  // Publish to rebirth feed
  if(PLAYER_ID){
    const feedEntry={
      id:uid(),
      playerId:PLAYER_ID,
      playerName:PLAYER_NAME,
      playerAvatar:PLAYER_AVATAR,
      prestige:G.prestige,
      droppedItems:dropped.map(instId=>{
        const inst=G.instances[instId];
        const item=ITEMS.find(x=>x.id===inst.itemId);
        return{name:item.name,icon:item.icon,rarity:item.rarity};
      }),
      ts:Date.now()
    };
    await safeSet('feed:'+feedEntry.id, feedEntry, true);
    await syncPlayerData();
    await saveGameState();
  }
}

function equipItem(instId){
  const inst=G.instances[instId];if(!inst)return;
  const item=ITEMS.find(x=>x.id===inst.itemId);if(!item)return;
  if(G.equipped[item.type])G.equipped[item.type]=null;
  G.equipped[item.type]=instId;
  recalc();renderEqStrip();renderItemsPage();closeModal();
  toast('Equipped: '+item.name);
}
function unequipItem(instId){
  const inst=G.instances[instId];if(!inst)return;
  const item=ITEMS.find(x=>x.id===inst.itemId);if(!item)return;
  if(G.equipped[item.type]===instId){
    G.equipped[item.type]=null;
    recalc();renderEqStrip();renderItemsPage();closeModal();
    toast('Unequipped: '+item.name);
  }
}

// ‚îÄ‚îÄ LIST ITEM IN MARKETPLACE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function listItem(instId){
  const priceInput=document.getElementById('sell-price-input');
  if(!priceInput)return;
  const price=parseFloat(priceInput.value);
  if(!price||price<=0){alert('–í—ä–≤–µ–¥–∏ –≤–∞–ª–∏–¥–Ω–∞ —Ü–µ–Ω–∞!');return;}
  if(!PLAYER_ID){alert('–í–ª–µ–∑ –≤ –∏–≥—Ä–∞—Ç–∞ –ø—ä—Ä–≤–æ!');return;}

  // Remove from inventory (listed = not available)
  const isEq=Object.values(G.equipped).includes(instId);
  if(isEq){alert('–°–≤–∞–ª–∏ –ø—Ä–µ–¥–º–µ—Ç–∞ –æ—Ç –µ–∫–∏–ø–∏—Ä–æ–≤–∫–∞ –ø—Ä–µ–¥–∏ –¥–∞ –≥–æ –ø—Ä–æ–¥–∞–≤–∞—à!');return;}

  const inst=G.instances[instId];
  const item=ITEMS.find(x=>x.id===inst.itemId);

  const listing={
    id:'lst_'+uid(),
    sellerId:PLAYER_ID,
    sellerName:PLAYER_NAME,
    sellerAvatar:PLAYER_AVATAR,
    sellerPrestige:G.prestige,
    instId,
    itemId:item.id,
    itemName:item.name,
    itemIcon:item.icon,
    itemRarity:item.rarity,
    itemStats:item.stats,
    price:Math.floor(price),
    currency:sellCurrency,
    ts:Date.now()
  };

  // Save listing to shared storage
  await safeSet('listing:'+listing.id, listing, true);

  // Mark item as listed in local state
  G.instances[instId].listed=listing.id;
  closeModal();
  toast('–û–±—è–≤–µ–Ω–æ: '+item.name+' –∑–∞ '+fmt(listing.price)+(sellCurrency==='tokens'?' —Ç–æ–∫–µ–Ω–∞':' –º–æ–Ω–µ—Ç–∏'));
  renderItemsPage();
  loadMyListings();
}

async function buyListing(listingId){
  const listing=await safeGet('listing:'+listingId, true);
  if(!listing){toast('–¢–∞–∑–∏ –æ–±—è–≤–∞ –≤–µ—á–µ –Ω–µ –µ –Ω–∞–ª–∏—á–Ω–∞.');loadListings();return;}
  if(listing.sellerId===PLAYER_ID){toast('–ù–µ –º–æ–∂–µ—à –¥–∞ –∫—É–ø—É–≤–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–∏—Ç–µ —Å–∏ –æ–±—è–≤–∏!');return;}

  const cost=listing.price;
  if(listing.currency==='coins'){
    if(G.coins<cost){toast('–ù—è–º–∞—à –¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ –º–æ–Ω–µ—Ç–∏!');return;}
    G.coins-=cost;
  } else {
    if(G.rebirthTokens<cost){toast('–ù—è–º–∞—à –¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ —Ç–æ–∫–µ–Ω–∏!');return;}
    G.rebirthTokens-=cost;
  }

  // Add item to our inventory
  const newInstId='i'+G.nextId++;
  G.instances[newInstId]={itemId:listing.itemId, id:newInstId};
  G.inventory.push(newInstId);

  // Remove listing from shared storage
  await safeDel('listing:'+listingId, true);

  const item=ITEMS.find(x=>x.id===listing.itemId);
  toast('–ö—É–ø–µ–Ω–æ: '+listing.itemName+' –æ—Ç '+listing.sellerName, 'toast-buy');
  recalc();renderItemsPage();renderEqStrip();loadListings();
}

async function cancelListing(listingId, instId){
  await safeDel('listing:'+listingId, true);
  if(G.instances[instId]){
    delete G.instances[instId].listed;
  }
  toast('–û–±—è–≤–∞—Ç–∞ –µ –æ—Ç–º–µ–Ω–µ–Ω–∞.');
  loadMyListings();renderItemsPage();
}

// ‚îÄ‚îÄ LEVEL / ACH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkLevel(){
  const t=lvlThresh(G.level);
  if(G.levelXP>=t){G.levelXP-=t;G.level++;G.clickPower+=1;toast('Level Up! Lv '+G.level);}
}
const ACHS=[
  {id:0,check:()=>G.clicks>=1},
  {id:1,check:()=>G.totalCoins>=100},
  {id:2,check:()=>Object.values(G.upgrades).some(v=>v>0)},
  {id:3,check:()=>G.cps>=1000},
  {id:4,check:()=>G.prestige>=1},
  {id:5,check:()=>G.clicks>=10000},
];
const ACH_NAMES=['First Click!','100 Coins!','First Upgrade!','1K CPS!','Rebirth!','10K Clicks!'];
function checkAch(){
  ACHS.forEach(a=>{
    if(!G.achievements.has(a.id)&&a.check()){
      G.achievements.add(a.id);
      document.getElementById('ach-'+a.id).classList.add('unlocked');
      toast('Achievement: '+ACH_NAMES[a.id]);
    }
  });
}

// ‚îÄ‚îÄ RENDER: SHOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderShop(){
  const c=document.getElementById('shop-items');c.innerHTML='';
  UPGRADES.forEach(u=>{
    const owned=G.upgrades[u.id];const cost=upgCost(u);const can=G.coins>=cost;
    const d=document.createElement('div');
    d.className='upgrade-card'+(can?' affordable':' locked');
    d.onclick=()=>buy(u.id);
    let eff='';
    if(u.baseCps>0)eff='+'+(u.baseCps*(1+G.prestige*.5)).toFixed(1)+'/s';
    if(u.baseClick>0)eff='+'+u.baseClick+' click';
    d.innerHTML=`<div class="ug-head"><div class="ug-icon">${u.icon}</div><div class="ug-name">${u.name}</div>${owned>0?'<div class="ug-owned">x'+owned+'</div>':''}</div><div class="ug-desc">${u.desc}</div><div class="ug-foot"><div class="ug-cost ${can?'':'cant'}">‚Çø ${fmt(cost)}</div><div class="ug-effect">${eff}</div></div>`;
    c.appendChild(d);
  });
}

// ‚îÄ‚îÄ RENDER: EQ STRIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEqStrip(){
  const strip=document.getElementById('eq-strip');strip.innerHTML='';
  SLOT_TYPES.forEach(t=>{
    const instId=G.equipped[t];
    const div=document.createElement('div');
    div.className='eq-slot'+(instId?' has-item':'');
    if(instId){
      const inst=G.instances[instId];
      const item=inst?ITEMS.find(x=>x.id===inst.itemId):null;
      if(item){
        div.innerHTML=`<span style="font-size:1.1rem">${item.icon}</span><div class="srb" style="background:${rc(item.rarity)}"></div>`;
        div.onclick=()=>openModal(instId);
      }
    } else {
      div.innerHTML=`<span style="font-size:.95rem;opacity:.25">${SLOT_ICONS[t]}</span>`;
    }
    strip.appendChild(div);
  });
  document.getElementById('token-strip').textContent='ü™ô '+fmt(G.rebirthTokens)+' tokens';
}

// ‚îÄ‚îÄ RENDER: ITEMS PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderItemsPage(){
  const grid=document.getElementById('equip-slots');grid.innerHTML='';
  SLOT_TYPES.forEach(t=>{
    const instId=G.equipped[t];
    const div=document.createElement('div');
    div.className='equip-slot'+(instId?' filled':'');
    if(instId){
      const inst=G.instances[instId];
      const item=inst?ITEMS.find(x=>x.id===inst.itemId):null;
      if(item){
        div.style.borderColor=rc(item.rarity);
        div.innerHTML=`<div class="es-type">${t}</div><div class="es-icon">${item.icon}</div><div class="es-name">${item.name}</div><div class="es-bar" style="background:${rc(item.rarity)}"></div>`;
        div.onclick=()=>openModal(instId);
      }
    } else {
      div.innerHTML=`<div class="es-type">${t}</div><div class="es-icon" style="opacity:.2">${SLOT_ICONS[t]}</div><div class="es-name" style="color:var(--muted)">Empty</div>`;
    }
    grid.appendChild(div);
  });
  const inv=document.getElementById('inventory-grid');
  document.getElementById('inv-count').textContent=G.inventory.length;
  if(G.inventory.length===0){
    inv.innerHTML='<div class="empty-inv">No items yet.<br>Do a <strong style="color:var(--purple)">Rebirth</strong> to get drops!<br><span style="font-size:.6rem;color:var(--muted)">Better Rebirths = Rarer items</span></div>';
    return;
  }
  inv.innerHTML='';
  G.inventory.forEach(instId=>{
    const inst=G.instances[instId];if(!inst)return;
    const item=ITEMS.find(x=>x.id===inst.itemId);if(!item)return;
    const isEq=Object.values(G.equipped).includes(instId);
    const isListed=!!inst.listed;
    const div=document.createElement('div');
    div.className='inv-item';div.style.borderColor=rc(item.rarity);
    div.style.borderBottomWidth='3px';
    if(isListed)div.style.opacity='.5';
    let statStr='';
    if(item.stats.cp)statStr+='+'+item.stats.cp+' pwr<br>';
    if(item.stats.cb)statStr+='+'+(item.stats.cb*100).toFixed(0)+'% CPS';
    div.innerHTML=`${isEq?'<div class="eqbadge">EQ</div>':''}${isListed?'<div class="listbadge">Listed</div>':''}<div class="inv-icon">${item.icon}</div><div class="inv-name">${item.name}</div><div class="inv-rarity" style="color:${rc(item.rarity)}">${RARITIES[item.rarity].name}</div><div class="inv-stats">${statStr}</div>`;
    div.onclick=()=>openModal(instId);
    inv.appendChild(div);
  });
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(instId){
  const inst=G.instances[instId];if(!inst)return;
  const item=ITEMS.find(x=>x.id===inst.itemId);if(!item)return;
  currentModalInst=instId;
  const isEq=Object.values(G.equipped).includes(instId);
  const isListed=!!inst.listed;
  const rar=RARITIES[item.rarity];
  document.getElementById('m-icon').innerHTML=item.icon;
  document.getElementById('m-name').textContent=item.name;
  document.getElementById('m-name').style.color=rar.color;
  document.getElementById('m-rarity').textContent=rar.name+' ¬∑ '+item.type;
  document.getElementById('m-rarity').style.color=rar.color;
  document.getElementById('m-desc').textContent=item.desc;
  let sh='';
  if(item.stats.cp)sh+=`<div class="modal-stat"><span>Click Power</span><span class="sv">+${item.stats.cp}</span></div>`;
  if(item.stats.cb)sh+=`<div class="modal-stat"><span>CPS Bonus</span><span class="sv">+${(item.stats.cb*100).toFixed(0)}%</span></div>`;
  document.getElementById('m-stats').innerHTML=sh;

  // Sell area
  const sellArea=document.getElementById('m-sell-area');
  if(!isEq&&!isListed){
    sellCurrency='coins';
    sellArea.innerHTML=`<div class="modal-sell-area">
      <label>üì¢ –û–±—è–≤–∏ –≤ Marketplace</label>
      <div class="sell-currency-toggle">
        <button class="sct-btn active" id="sct-coins" onclick="setSellCurrency('coins')">‚Çø –ú–æ–Ω–µ—Ç–∏</button>
        <button class="sct-btn" id="sct-tokens" onclick="setSellCurrency('tokens')">ü™ô Tokens</button>
      </div>
      <div class="modal-sell-row">
        <input type="number" class="modal-sell-input" id="sell-price-input" placeholder="–¶–µ–Ω–∞..." min="1"/>
        <button class="modal-btn btn-sell" onclick="listItem('${instId}')">–û–±—è–≤–∏</button>
      </div>
    </div>`;
  } else if(isListed){
    sellArea.innerHTML=`<div style="font-size:.6rem;color:var(--gold);padding:7px;background:rgba(255,215,0,.05);border:1px solid rgba(255,215,0,.2);border-radius:2px;margin-bottom:8px;">üìã –û–±—è–≤–µ–Ω –≤ Marketplace</div>`;
  } else {
    sellArea.innerHTML='';
  }

  document.getElementById('m-btns').innerHTML=isEq
    ?`<button class="modal-btn btn-unequip" onclick="unequipItem('${instId}')">Unequip</button><button class="modal-btn btn-close" onclick="closeModal()">Close</button>`
    :`<button class="modal-btn btn-equip" onclick="equipItem('${instId}')" ${isListed?'disabled':''}>Equip</button><button class="modal-btn btn-close" onclick="closeModal()">Close</button>`;
  document.getElementById('modal').style.display='flex';
}

function setSellCurrency(cur){
  sellCurrency=cur;
  document.getElementById('sct-coins').classList.toggle('active',cur==='coins');
  document.getElementById('sct-tokens').classList.toggle('active',cur==='tokens');
}

function closeModal(e){
  if(!e||e.target===document.getElementById('modal')){
    document.getElementById('modal').style.display='none';
    currentModalInst=null;
  }
}

// ‚îÄ‚îÄ DROP SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showDropScreen(dropped, tokens){
  const c=document.getElementById('drop-items');c.innerHTML='';
  dropped.forEach(instId=>{
    const inst=G.instances[instId];
    const item=ITEMS.find(x=>x.id===inst.itemId);
    const rar=RARITIES[item.rarity];
    const d=document.createElement('div');
    d.className='drop-item';
    d.style.border='1px solid '+rar.color;
    d.style.boxShadow='0 0 16px '+rar.color+'44';
    d.innerHTML=`<div class="drop-icon">${item.icon}</div><div class="drop-name" style="color:${rar.color}">${item.name}</div><div class="drop-rtag" style="background:${rar.color}22;color:${rar.color};border:1px solid ${rar.color}55">${rar.name}</div>`;
    c.appendChild(d);
  });
  document.getElementById('drop-token-reward').textContent='ü™ô +'+tokens+' Rebirth Token'+(tokens>1?'s':'');
  document.getElementById('drop-overlay').style.display='flex';
}
function closeDrop(){
  document.getElementById('drop-overlay').style.display='none';
  renderEqStrip();renderItemsPage();
  toast('‚ôªÔ∏è Rebirth x'+G.prestige+' done! +50% permanent bonus!');
}

// ‚îÄ‚îÄ MARKETPLACE LOADERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadListings(){
  const grid=document.getElementById('listings-grid');
  grid.innerHTML='<div class="no-listings">Loading...</div>';
  try{
    const keys=await safeList('listing:', true);
    const listings=[];
    for(const k of keys){
      const v=await safeGet(k, true);
      if(v)listings.push(v);
    }
    // Sort by newest first
    listings.sort((a,b)=>b.ts-a.ts);
    renderListings(listings);
  }catch(e){
    grid.innerHTML='<div class="no-listings">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ.</div>';
  }
}

function renderListings(listings){
  const grid=document.getElementById('listings-grid');
  let filtered=listings;
  if(currentFilter==='coins')filtered=listings.filter(l=>l.currency==='coins');
  else if(currentFilter==='tokens')filtered=listings.filter(l=>l.currency==='tokens');
  else if(['common','rare','epic','legendary'].includes(currentFilter))
    filtered=listings.filter(l=>l.itemRarity===currentFilter);

  if(filtered.length===0){
    grid.innerHTML='<div class="no-listings">–ù—è–º–∞ –æ–±—è–≤–∏. –ë—ä–¥–∏ –ø—ä—Ä–≤–∏—è—Ç!<br><span style="font-size:.6rem">–û–±—è–≤–∏ item –æ—Ç Items ‚Üí –∫–ª–∏–∫ –≤—ä—Ä—Ö—É –ø—Ä–µ–¥–º–µ—Ç</span></div>';
    return;
  }
  grid.innerHTML='';
  filtered.forEach(l=>{
    const item=ITEMS.find(x=>x.id===l.itemId);
    const rar=RARITIES[l.itemRarity]||RARITIES.common;
    const isMe=l.sellerId===PLAYER_ID;
    const canAfford=l.currency==='coins'?G.coins>=l.price:G.rebirthTokens>=l.price;
    let statStr='';
    if(l.itemStats?.cp)statStr+='+'+l.itemStats.cp+' pwr ';
    if(l.itemStats?.cb)statStr+='+'+(l.itemStats.cb*100).toFixed(0)+'% CPS';

    const card=document.createElement('div');
    card.className='listing-card';
    card.style.setProperty('--rar-color', rar.color);
    card.querySelector?.('::after')?.style.setProperty?.('background',rar.color);
    card.innerHTML=`
      <style>.listing-card[data-id="${l.id}"]::after{background:${rar.color}}</style>
      ${isMe?'<div class="lc-my-badge">My Listing</div>':''}
      <div class="lc-seller"><span>${l.sellerAvatar||'üë§'}</span><span class="lc-seller-name">${l.sellerName}</span>
        <span class="lc-seller-rb">‚ôªÔ∏è x${l.sellerPrestige}</span></div>
      <div class="lc-item">
        <div class="lc-icon">${l.itemIcon}</div>
        <div class="lc-item-info">
          <div class="lc-name">${l.itemName}</div>
          <div class="lc-rarity" style="color:${rar.color}">${rar.name}</div>
          <div class="lc-stats">${statStr}</div>
        </div>
      </div>
      <div class="lc-price">
        <span class="lc-price-val ${l.currency}">${l.currency==='coins'?'‚Çø':'ü™ô'} ${fmt(l.price)}</span>
        ${!isMe?`<button class="lc-buy-btn ${l.currency}" onclick="buyListing('${l.id}')" ${!canAfford?'disabled':''}>–ö—É–ø–∏</button>`
               :`<button class="lc-buy-btn" style="background:rgba(255,68,102,.1);border:1px solid var(--red);color:var(--red)" onclick="cancelListing('${l.id}','${l.instId}')">–û—Ç–º–µ–Ω–∏</button>`}
      </div>`;
    card.dataset.id=l.id;
    grid.appendChild(card);
  });
}

function setFilter(f,btn){
  currentFilter=f;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  loadListings();
}

async function loadLeaderboard(){
  const list=document.getElementById('leaderboard-list');
  list.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted)">Loading...</div>';
  try{
    const keys=await safeList('player:', true);
    const players=[];
    for(const k of keys){
      const v=await safeGet(k, true);
      if(v)players.push(v);
    }
    players.sort((a,b)=>b.prestige-a.prestige||b.level-a.level);
    if(players.length===0){
      list.innerHTML='<div class="feed-empty">–ù—è–º–∞ –∏–≥—Ä–∞—á–∏ –æ—â–µ. –ü–æ–∫–∞–Ω–∏ –ø—Ä–∏—è—Ç–µ–ª–∏!</div>';
      return;
    }
    list.innerHTML='';
    players.forEach((p,i)=>{
      const row=document.createElement('div');
      const rankClass=i===0?'gold':i===1?'silver':i===2?'bronze':'';
      row.className='lb-row'+(p.id===PLAYER_ID?' lb-me':'');
      row.innerHTML=`
        <div class="lb-rank ${rankClass}">${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':(i+1)}</div>
        <div class="lb-avatar">${p.avatar||'üë§'}</div>
        <div class="lb-name">${p.name}${p.id===PLAYER_ID?'<span class="lb-you-tag">YOU</span>':''}
          <small>Lv ${p.level||1} &nbsp;‚Ä¢&nbsp; ${fmt(p.cps||0)} CPS</small></div>
        <div class="lb-prestige">‚ôªÔ∏è ${p.prestige} <span>rebirths</span></div>`;
      list.appendChild(row);
    });
  }catch(e){
    list.innerHTML='<div class="feed-empty">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ.</div>';
  }
}

async function loadFeed(){
  feedUnread=0;
  document.getElementById('feed-badge').style.display='none';
  const list=document.getElementById('feed-list');
  list.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted)">Loading...</div>';
  try{
    const keys=await safeList('feed:', true);
    const entries=[];
    for(const k of keys){
      const v=await safeGet(k, true);
      if(v)entries.push(v);
    }
    entries.sort((a,b)=>b.ts-a.ts);
    const recent=entries.slice(0,50);
    if(recent.length===0){
      list.innerHTML='<div class="feed-empty">–ù—è–º–∞ rebirth –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç.<br>–ë—ä–¥–∏ –ø—ä—Ä–≤–∏—è—Ç!</div>';
      return;
    }
    list.innerHTML='';
    recent.forEach(e=>{
      const row=document.createElement('div');
      row.className='feed-item';
      const itemsHtml=e.droppedItems.map(it=>
        `<span class="feed-item-tag" style="color:${RARITIES[it.rarity]?.color||'#aaa'};border-color:${RARITIES[it.rarity]?.color||'#aaa'}33;background:${RARITIES[it.rarity]?.color||'#aaa'}11">${it.icon} ${it.name}</span>`
      ).join('');
      row.innerHTML=`
        <div class="feed-avatar">${e.playerAvatar||'üë§'}</div>
        <div class="feed-text">
          <strong>${e.playerName}</strong> –∑–∞–≤—ä—Ä—à–∏ <strong>Rebirth #${e.prestige}</strong>!
          <div class="feed-items-row">${itemsHtml}</div>
        </div>
        <div class="feed-time">${timeAgo(e.ts)}</div>`;
      list.appendChild(row);
    });
  }catch(e){
    list.innerHTML='<div class="feed-empty">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ.</div>';
  }
}

async function checkFeedUpdates(){
  try{
    const keys=await safeList('feed:', true);
    const entries=[];
    for(const k of keys){
      const v=await safeGet(k, true);
      if(v&&v.playerId!==PLAYER_ID)entries.push(v);
    }
    entries.sort((a,b)=>b.ts-a.ts);
    if(entries.length>0&&entries[0].ts>Date.now()-25000){
      feedUnread++;
      const badge=document.getElementById('feed-badge');
      badge.style.display='inline-block';
      // Show toast notification
      const e=entries[0];
      const t=document.createElement('div');
      t.className='toast toast-rebirth';
      t.innerHTML=`‚ôªÔ∏è ${e.playerAvatar} ${e.playerName} did Rebirth #${e.prestige}!`;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),3000);
    }
  }catch(e){}
}

async function loadMyListings(){
  const list=document.getElementById('my-listings-list');
  if(!PLAYER_ID){list.innerHTML='<div class="feed-empty">–¢—Ä—è–±–≤–∞ –¥–∞ –≤–ª–µ–∑–µ—à –≤ –∏–≥—Ä–∞—Ç–∞.</div>';return;}
  list.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted)">Loading...</div>';
  try{
    const keys=await safeList('listing:', true);
    const myListings=[];
    for(const k of keys){
      const v=await safeGet(k, true);
      if(v&&v.sellerId===PLAYER_ID)myListings.push(v);
    }
    myListings.sort((a,b)=>b.ts-a.ts);
    if(myListings.length===0){
      list.innerHTML='<div class="feed-empty">–ù—è–º–∞—à –∞–∫—Ç–∏–≤–Ω–∏ –æ–±—è–≤–∏.<br>–û—Ç–∏–¥–∏ –≤ Items, –∫–ª–∏–∫–Ω–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –∏ –≥–æ –æ–±—è–≤–∏!</div>';
      return;
    }
    list.innerHTML='';
    myListings.forEach(l=>{
      const rar=RARITIES[l.itemRarity]||RARITIES.common;
      const row=document.createElement('div');
      row.className='my-listing-card';
      row.innerHTML=`
        <div class="mlc-icon">${l.itemIcon}</div>
        <div class="mlc-info">
          <div class="mlc-name" style="color:${rar.color}">${l.itemName} <span style="color:var(--muted);font-size:.55rem">(${rar.name})</span></div>
          <div class="mlc-price ${l.currency==='tokens'?'tokens':''}">${l.currency==='coins'?'‚Çø':'ü™ô'} ${fmt(l.price)} ${l.currency==='coins'?'–º–æ–Ω–µ—Ç–∏':'—Ç–æ–∫–µ–Ω–∞'} ¬∑ ${timeAgo(l.ts)}</div>
        </div>
        <button class="mlc-cancel" onclick="cancelListing('${l.id}','${l.instId}')">–û—Ç–º–µ–Ω–∏</button>`;
      list.appendChild(row);
    });
  }catch(e){
    list.innerHTML='<div class="feed-empty">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ.</div>';
  }
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(name,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  btn.classList.add('active');
  if(name==='items')renderItemsPage();
  if(name==='market'){
    loadListings();
    loadLeaderboard();
  }
}

function switchMarketTab(name,btn){
  document.querySelectorAll('.market-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.market-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('market-'+name).classList.add('active');
  btn.classList.add('active');
  if(name==='listings')loadListings();
  if(name==='leaderboard')loadLeaderboard();
  if(name==='feed')loadFeed();
  if(name==='mylistings')loadMyListings();
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, cls=''){
  const el=document.createElement('div');
  el.className='toast'+(cls?' '+cls:'');
  el.innerHTML=msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),2600);
}

// ‚îÄ‚îÄ GAME LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function gameLoop(){
  const tick=G.cps/20;
  G.coins+=tick;G.totalCoins+=tick;G.levelXP+=tick;
  checkLevel();
  document.getElementById('balance').textContent=fmt(G.coins);
  document.getElementById('per-sec').textContent='+'+fmt(G.cps)+' coins/sec';
  document.getElementById('click-power').textContent=fmt(G.clickPower);
  document.getElementById('level-num').textContent=G.level;
  document.getElementById('lvl-cur').textContent=G.level;
  const t=lvlThresh(G.level);
  document.getElementById('lvl-prog').textContent=fmt(G.levelXP)+'/'+fmt(t);
  document.getElementById('lvl-bar').style.width=Math.min(100,G.levelXP/t*100)+'%';
  document.getElementById('stat-total').textContent=fmt(G.totalCoins);
  document.getElementById('stat-clicks').textContent=fmt(G.clicks);
  document.getElementById('stat-cps').textContent=fmt(G.cps);
  document.getElementById('stat-prestige').textContent=G.prestige;
  document.getElementById('prestige-btn').disabled=G.totalCoins<1000000;
  document.getElementById('market-token-display').textContent=G.rebirthTokens;
  document.getElementById('token-strip').textContent='ü™ô '+G.rebirthTokens+' tokens';
  document.querySelectorAll('.upgrade-card').forEach((card,i)=>{
    const u=UPGRADES[i];const cost=upgCost(u);const can=G.coins>=cost;
    card.classList.toggle('affordable',can);card.classList.toggle('locked',!can);
    const ce=card.querySelector('.ug-cost');if(ce)ce.classList.toggle('cant',!can);
  });
}

recalc();renderShop();renderEqStrip();
setInterval(gameLoop,50);

// ‚îÄ‚îÄ STARTUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async()=>{
  const saved=localStorage.getItem('cm_firebase_cfg');
  if(saved){
    try{
      const cfg=JSON.parse(saved);
      // Pre-fill fields
      document.getElementById('fb-apiKey').value=cfg.apiKey||'';
      document.getElementById('fb-projectId').value=cfg.projectId||'';
      document.getElementById('fb-dbUrl').value=cfg.databaseURL||'';
      await loadFirebase(cfg);
    }catch(e){
      document.getElementById('fb-setup').style.display='flex';
    }
  } else {
    document.getElementById('fb-setup').style.display='flex';
  }
})();
</script>
</body>
</html>
